import imp
import argparse
import numpy as np

'''
parser = argparse.ArgumentParser(description="Parse a file using a stored model.")
args = parser.parse_args()
'''

algorithm = "distmult"
train_triplets = "data/FB15k/freebase_mtr100_mte100-train.txt"
valid_triplets = "data/FB15k/freebase_mtr100_mte100-valid.txt"
test_triplets = "data/FB15k/freebase_mtr100_mte100-test.txt"
entities = "data/FB15k/entities.dict"
relations = "data/FB15k/relations.dict"
outfilepath = "test.txt"

io = imp.load_source('io', 'code/common/io.py')
algorithm = imp.load_source('algorithm', 'code/experts/'+algorithm+'/model.py')

train_triplets = io.read_triplets_as_list(train_triplets, entities, relations)
valid_triplets = io.read_triplets_as_list(valid_triplets, entities, relations)
test_triplets = io.read_triplets_as_list(test_triplets, entities, relations)

entities = io.read_dictionary(entities)
relations = io.read_dictionary(relations)

extended_triplets = []

def remove(triplet):
    global train_triplets
    global valid_triplets
    global test_triplets

    return triplet in train_triplets or triplet in valid_triplets or triplet in test_triplets

def search_triplets(triplets, head):
    for i,triplet in enumerate(triplets):
        if head == triplet[0]:
            return i, triplet[1]
    return -1,-1

positives = {}
for triplet in train_triplets:
    if triplet[0] not in positives:
        positives[triplet[0]] = {triplet[1] : [triplet[2]]}
    else:
        if triplet[1] not in positives[triplet[0]]:
            positives[triplet[0]][triplet[1]] = [triplet[2]]
        else:
            positives[triplet[0]][triplet[1]].append(triplet[2])

for triplet in valid_triplets:
    if triplet[0] not in positives:
        positives[triplet[0]] = {triplet[1] : [triplet[2]]}
    else:
        if triplet[1] not in positives[triplet[0]]:
            positives[triplet[0]][triplet[1]] = [triplet[2]]
        else:
            positives[triplet[0]][triplet[1]].append(triplet[2])

for triplet in test_triplets:
    if triplet[0] not in positives:
        positives[triplet[0]] = {triplet[1] : [triplet[2]]}
    else:
        if triplet[1] not in positives[triplet[0]]:
            positives[triplet[0]][triplet[1]] = [triplet[2]]
        else:
            positives[triplet[0]][triplet[1]].append(triplet[2])

            
def included(dic, triplet):
    if triplet[0] not in dic:
        return False
    if triplet[1] not in dic[triplet[0]]:
        return False
    else:
        return triplet[2] in dic[triplet[0]][triplet[1]]
            
outfile = open(outfilepath, 'w+')
for i,triplet in enumerate(valid_triplets):
    print(i)
    entities = range(10)
    extended_triplets = [[i, triplet[1], triplet[2]] for i in range(len(entities))]
    raw_predictions = list(sorted(enumerate(algorithm.predict(extended_triplets)),key=lambda x: x[1], reverse=True))    
    filtered_predictions = [item for item in raw_predictions if item[0] == triplet[0] or not included(positives, [item[0], triplet[1], triplet[2]])]

    raw_correct = search_triplets(raw_predictions, triplet[0])
    filtered_correct = search_triplets(filtered_predictions, triplet[0])

    print(str(raw_correct[0]) +
          '\t'+ str(filtered_correct[0]) +
          '\t'+ str(raw_correct[1]))
          #, file=outfile)
